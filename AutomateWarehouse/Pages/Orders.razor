@page "/allOrders"
@using AutomateWarehouse.Data
@*@inject OrderRepository orderRepo
@inject OrderLineRepository orderLineRepo
@inject ProductRepository productRepo
@inject CustomerRepository customerRepo*@
@inject IOrderRepository orderRepo
@inject IOrderLineRepository orderLineRepo
@inject IProductRepository productRepo
@inject ICustomerRepository customerRepo



<h3>Orders</h3>

<div class="container">
    <table class="table table-bordered">
        <thead class="thead-dark">
            <tr>
                <th>Customer id</th>
                <th>Order date</th>
                <th>Delivery address</th>
                <th>Payment completed</th>
                <th>Order dispatched</th>
                <th>Order lines</th>
                <th>Edit order</th>
                <th>Pay order</th>
            </tr>
        </thead>
        <tbody>
            @if (orders.Any())
            {
                @foreach (var order in orders)
                {
                    <tr>
                        <td>@order.CustomerId</td>
                        <td>@order.OrderDate</td>
                        <td>@order.DeliveryAddress</td>
                        <td>
                            @if (order.PaymentCompleted == true)
                            {
                                <p>Paid</p>
                            }
                            else
                            {
                                <p>Not paid</p>
                            }
                        </td>
                        <td>
                            @if (order.Dispatched == true)
                            {
                                <p>Dispatched</p>
                            }
                            else
                            {
                                <p>Not dispatched</p>
                            }
                        </td>
                        <td><button class="btn btn-info" @onclick="(() => ShowAllOrderLines(order))">Show order lines</button></td>
                        <td><button class="btn btn-info" @onclick="(() => SetOrderForEdit (order))">Edit</button></td>

                        <td>
                            @if (!order.PaymentCompleted)
                            {
                                <input type="button" name="PayButton" class="btn btn-info" id="PayButton" value="Pay" @onclick="(() => PayOrderAsync(order))" />
                            }
                            else
                            {
                                <input type="button" name="UndoPayButton" class="btn btn-info" id="UndoPayButton" value="UndoPay" @onclick="(() => UndoPayment(order))" />
                            }
                        </td>
                    </tr>

                    <tr>
                        @if (orderLines != null)
                        {

                            @if (orderLines.Any())
                            {
                                <td colspan="8">
                                    @foreach (var orderLine in orderLines)
                                    {
                                        @if (order.Id == orderLine.OrderId)
                                        {
                                            <p>Order lines</p>
                                            <table class="table table-bordered">

                                                <thead class="thead-dark">
                                                    <tr>
                                                        <th>Order line Id</th>
                                                        <th>Product Id</th>
                                                        <th>Product name</th>
                                                        <th>Quantity</th>
                                                        <th>Order Id</th>
                                                        <th>Customer name</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>@orderLine.Id</td>
                                                        <td>@orderLine.ProductId</td>
                                                        <td>@orderLine.Product.Name</td>
                                                        <td>@orderLine.Quantity</td>
                                                        <td>@orderLine.OrderId</td>
                                                        <td>@orderLine.Order.Customer.Name</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        }
                                    }
                                </td>
                            }
                            else if (currentOrder.Id == order.Id)
                            {
                                <td colspan="8" align="center">
                                    <p>No order lines found</p>
                                </td>
                            }
                        }
                    </tr>
                }
            }
        </tbody>
    </table>

    <button class="btn btn-info" @onclick="(() => GetAllOrdersAsync())">Show all orders</button>
    <button class="btn btn-info" @onclick="(() => GetAllDispatchedOrdersAsync())">Show all dispatched orders</button>
    <button class="btn btn-info" @onclick="(() => GetAllPendingdOrdersAsync())">Show all pending orders</button>
    <button class="btn btn-info" @onclick="(() => DispatchAllOrders())">Process all orders</button>
    <div class="row m-2">
            <div class="col-5 bg-light m-2 justify-content-start">
                <div class="p-3 mb-3 bg-secondary text-white text-center">
                    Create new Order
                </div>
                <EditForm Model="@newOrder" OnValidSubmit="(() => AddNewOrder())">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <div class="form-group">
                        @*Binder respektive värde nedanför till objektet updateOrder*@
                        <label for="ord">Pick customer</label>
                        <select type="type" id="ord" class="form-control select-picker" @bind="@newOrder.CustomerId">
                            @foreach (var cust in customers)
                            {
                                <option value="@cust.Id">@cust.Name</option>
                            }
                        </select>
                        <br>
                        <label for="address">Delivery address</label>
                        <input type="type" id="address" class="form-control" @bind-value="@newOrder.DeliveryAddress" />
                        <br>
                        <button class="btn btn-info" type="submit">
                            Add Order
                        </button>
                    </div>
                </EditForm>
            </div>
        <div class="col-5 bg-light m-2 justify-content-start">
            <div class="p-3 mb-3 bg-secondary text-white text-center">
                Edit Order
            </div>
            <EditForm Model="@updateOrder" OnValidSubmit="(() => EditOrder())">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <div class="form-group">
                    @*Binder respektive värde nedanför till objektet updateOrder*@
                    <label for="deliveryAddress">Delivery address</label>
                    <input type="type" id="deliveryAddress" class="form-control" @bind-value="@updateOrder.DeliveryAddress" />
                </div>
                <div class="text-center p-3 mb-3">
                    <button class="btn btn-info" type="submit">Edit Customer</button>
                </div>
                    @if (updateOrder.Dispatched)
                    {
                        <button class="btn btn-info" @onclick="(() => UndoDispatch(updateOrder))">Undo dispatch</button>
                    }
            </EditForm>
        </div>
    </div>
</div>


@code {
    private List<Order> orders;
    //private List<Order> ordersDispatched = new List<Order>();
    //private List<Order> ordersPending = new List<Order>();
    private List<OrderLine> orderLines = new List<OrderLine>();
    private List<Customer> customers;
    private List<Product> products;

    private Order currentOrder = new Order();
    //private List<OrderLine> orderLines;
    private List<Product> ListOfProducts;
    private List<Customer> ListOfCustomers;

    Order newOrder = new Order();
    Order updateOrder = new Order();
    bool checkedValue = false;

    OrderLine newOrderLine = new OrderLine();

    protected override async Task OnInitializedAsync()
    {
        orders = await orderRepo.GetAllOrdersAsync();
        customers = await customerRepo.GetCustomerAsync();
        products = await productRepo.GetAllProductsAsync();
    }

    private async Task AddNewOrder()
    {
        await orderRepo.AddNewOrderAsync(newOrder);
        newOrder = new Order();
        await UpdateGUI();
    }

    private async Task EditOrder()
    {
        await orderRepo.EditOrderAsync(updateOrder);
        updateOrder = new Order();
    }

    private void SetOrderForEdit(Order selected)
    {
        updateOrder = selected;
    }

    private async Task PayOrderAsync(Order order)
    {
        await orderRepo.PayOrderAsync(order);
        await UpdateGUI();
    }

    private async Task UndoPayment(Order order)
    {
        await orderRepo.UndoPaymentAsync(order);
        await UpdateGUI();
    }

    private async Task UndoDispatch(Order order)
    {
        await orderRepo.UndoDispatchAsync(order);
        await UpdateGUI();
    }

    private async Task DispatchAllOrders()
    {
        await orderRepo.ProcessOrderAsync();
        await UpdateGUI();
    }

    private async Task GetAllOrdersAsync()
    {
        orders = await orderRepo.GetAllOrdersAsync();
    }

    private async Task GetAllDispatchedOrdersAsync()
    {
        orders = await orderRepo.GetAllDispatchedOrdersAsync();
    }

    private async Task GetAllPendingdOrdersAsync()
    {
        orders = await orderRepo.GetAllPendingOrdersAsync();
    }

    protected async Task UpdateGUI()
    {
        orders = await orderRepo.GetAllOrdersAsync();
    }


    private async Task ShowAllOrderLines(Order selectedOrder)
    {
        currentOrder = selectedOrder;
        orderLines = await orderLineRepo.GetCurrentOrderLinesAsync(currentOrder);
        ListOfProducts = await productRepo.GetAllProductsAsync();
        ListOfCustomers = await customerRepo.GetCustomerAsync();
        //await UpdateGUI();
    }
}
